<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>Migrate to ADW - Migrate EDW to Azure SQL Data Warehouse</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

    <meta name="description" content="Azure Workshops" />
    <meta name="author" content="Jim Rosengarth">
    <link rel="icon" href="" type="image/x-icon">
    
    <!-- Font -->
    
    <!-- CSS -->
    <link href='../themes/azure/css/vs.css' rel='stylesheet' type='text/css'><link href='../themes/azure/css/theme.css' rel='stylesheet' type='text/css'><link href='../themes/azure/css/theme-white.min.css' rel='stylesheet' type='text/css'>
</head>
<body class="">

        <nav class="navbar navbar-inverse">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-2 col-md-offset-1">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="/">Azure Workshops</a>
                    </div>
                </div>

                <div class="col-md-8">
                    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                        <ul class="nav navbar-nav navbar-right">
                            <!--
                            <li><a href="about.html">About</a></li>
                            <li><a href="contact.html">Contact</a></li>
                            -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

<div id="content-wrapper" class="container-fluid">
    <div class="row hidden-print">
        <div class="col-md-10 col-md-offset-1 breadcrumbs">
            <a href="../index.html">Migrate EDW to Azure SQL Data Warehouse</a> / <a href="../Courseware/Configure_Azure_Services.html">Courseware</a> / <a href="../Courseware/Migrate_to_ADW.html">Migrate to ADW</a>        </div>
    </div>
    <div class="row">
        <div class="col-md-2 col-md-offset-1 hidden-print">
            <div data-spy="affix" data-offset-top="100">
                <!-- Navigation -->
                <ul class='Nav'><li class='Nav__item '><a href="../Overview.html">Overview</a></li><li class='Nav__item  has-children'><a href="#" class="aj-nav folder"><i class="Nav__arrow">&nbsp;</i>Getting Started</a><ul class='Nav'><li class='Nav__item '><a href="../Getting_Started/Requirements.html">Requirements</a></li><li class='Nav__item '><a href="../Getting_Started/Azure_Registration.html">Azure Registration</a></li><li class='Nav__item '><a href="../Getting_Started/Environment_Setup.html">Environment Setup</a></li></ul></li><li class='Nav__item Nav__item--open has-children'><a href="#" class="aj-nav folder"><i class="Nav__arrow">&nbsp;</i>Courseware</a><ul class='Nav'><li class='Nav__item '><a href="../Courseware/Configure_Azure_Services.html">Configure Azure Services</a></li><li class='Nav__item '><a href="../Courseware/Data_and_Schema_Preparation.html">Data and Schema Preparation</a></li><li class='Nav__item Nav__item--active'><a href="../Courseware/Migrate_to_ADW.html">Migrate to ADW</a></li><li class='Nav__item '><a href="../Courseware/Integrare_with_ADF.html">Integrare with ADF</a></li></ul></li></ul>
                <div class="Links">
                    
                    <div class="pdf-link">
                        <hr />
                        <a href="../pdf/Migrate EDW to Azure SQL Data Warehouse.pdf"><i class="fa fa-file-pdf-o" aria-hidden="true"></i> <span>Download PDF</span></a>
                    </div>

                                            <hr/>
                        <div class="Twitter">
                                                            <iframe allowtransparency="true" frameborder="0" scrolling="no" style="width:162px; height:20px;" src="https://platform.twitter.com/widgets/follow_button.html?screen_name=azureworkshops&amp;show_count=false"></iframe>
                                <br />
                                <br />
                                                    </div>
                                    </div>
            </div>
        </div>
        <div class="col-md-6">
            <article class="Page">
    <div class="pageHeader">
        <h1>Migrate to ADW</h1>
                    <div class="date"> Friday, September 15, 2017 5:25 PM</div>
            </div>
    <div class="copy">
        <h2 id="page_Exercise-3-Migrate-the-data-to-Azure-SQL-Data-Warehouse"><strong>Exercise 3:</strong> Migrate the data to Azure SQL Data Warehouse</h2>
<p><strong>Overview:</strong> This exercise is focused on migrating the data from your existing data warehouse into SQL Data Warehouse. We will be pulling the data and then uploading it to an Azure storage account. We will then import the data via Polybase.</p>
<h3 id="page_Task-1-Exporting-data-from-your-current-data-warehouse"><strong>Task 1:</strong> Exporting data from your current data warehouse.</h3>
<ol>
<li>
<p>Connect to your <strong>SQLCohoDW</strong> virtual machine.</p>
</li>
<li>
<p>Open the <strong>C:\Hackathon\bcp_commands.txt</strong> file. These are the bcp commands for each of the tables you need to migrate. The line below is an example. Notice the bcp commands all use the -C 65001 parameter. This indicates that the output will be in UTF-8 which is required by Polybase. This code page is only an option with bcp.exe that ships with SQL Server 2016 tools. If you are using an older version of bcp you will have an additional step to convert to UTF-8.</p>
</li>
</ol>
<pre><code class="language-PowerShell">bcp &quot;select [ScenarioKey],REPLACE([ScenarioName],'|','||') from [CohoDW].[dbo].[DimScenario]&quot; queryout &quot;C:\Migration/dbo.DimScenario.txt&quot; -q -c -C 65001 -t &quot;|&quot; -r &quot;\n&quot; -S SQLCohoDW -T
</code></pre>
<ol start="3">
<li>Close the file after you are done reviewing it. Change the file name to <strong>bcp_commands.bat</strong>.</li>
</ol>
<img src="../images/change_file_name.jpg" class="block"/>
<ol start="4">
<li>Open a command prompt and execute <strong>C:\Hackathon\bcp_commands.bat</strong>
</li>
</ol>
<div class="bs-callout bs-callout-primary"><h4>Note</h4> In a production environment you would likely make some effort to parallelize the execution of the various bcp commands. For larger tables, you also might parallelize the export from a single table.</div>

<ol start="5">
<li>Navigate to the <strong>C:\Migration</strong> folder. If the commands completed successfully you will have <strong>33 files</strong>.</li>
</ol>
<img src="../images/migration_folder.jpg" class="block"/>
<h3 id="page_Task-2-Transfer-your-data-to-Azure"><strong>Task 2:</strong> Transfer your data to Azure</h3>
<ol>
<li>
<p>From your SQLCohoDW virtual machine navigate to you C:\Hackathon folder and double-click <strong>MicrosoftAzureStorageTools.msi</strong> to install AzCopy.</p>
</li>
<li>
<p>In the Azure Portal navigate to your <strong>EDWmigrationStor</strong> resource group and click on your storage account.</p>
</li>
<li>
<p>In the Storage account blade, under settings, click on <strong>Access keys</strong></p>
</li>
</ol>
<img src="../images/storage_account_blade.jpg" class="block"/>
<ol start="4">
<li>Copy the storage account name and access key1 and paste into notepad for later use.</li>
</ol>
<img src="../images/storage_access_keys.jpg" class="block"/>
<ol start="5">
<li>
<p>Open a command prompt and navigate to the <strong>C:\Program Files (x86)\Microsoft SDKs\Azure\AzCopy</strong> folder.</p>
</li>
<li>
<p>Update the following command with your storage account name and key then execute it to begin copying your data files to Azure (all of the text is a single command)</p>
</li>
</ol>
<pre><code class="language-PowerShell">AzCopy /Source:&quot;C:\Migration&quot; /Dest:https://&lt;YourStorageAccount&gt;.blob.core.windows.net/migration /DestKey:&lt;YourStorageAccountKey&gt; /pattern:*.txt /NC:2
</code></pre>
<ol start="7">
<li>Confirm that all 33 files were transferred successfully.</li>
</ol>
<img src="../images/confirm_files_transfer.jpg" class="block"/>
<pre><code>* Confirm that the files are in the correct storage container by navigating to your storage account, clicking on blobs, then clicking on your container.
</code></pre>
<img src="../images/confirm_files_in_storage_container.jpg" class="block"/>
<ol start="8">
<li>
<p>Open SQL Server Management Studio and connect to your SQL Data Warehouse.</p>
</li>
<li>
<p>Open a new query window and execute the following command to create a master key for your database.</p>
</li>
</ol>
<pre><code class="language-SQL">CREATE MASTER KEY
</code></pre>
<ol start="10">
<li>Execute the following to create a database scoped credential that you will use to store the access key to the migration storage account.</li>
</ol>
<pre><code class="language-SQL">CREATE DATABASE SCOPED CREDENTIAL MigrationCredential
WITH IDENTITY = '&lt;YourStorageAccountName&gt;' , SECRET = '&lt;YourStorageAccountKey&gt;'
</code></pre>
<ol start="11">
<li>Create an external file format by executing the following query. The external file format defines the external storage and its layout.</li>
</ol>
<pre><code class="language-SQL">CREATE EXTERNAL DATA SOURCE MigrationStor WITH (TYPE = HADOOP ,
LOCATION=
'wasbs://&lt;YourStorageContainerName&gt;@&lt;YourStorageAccountName&gt;.blob.core.windows.net',
CREDENTIAL = MigrationCredential);
</code></pre>
<ol start="12">
<li>Create an external file format by executing the following query. The external file format defines the external storage and its layout.</li>
</ol>
<pre><code class="language-SQL">CREATE EXTERNAL FILE FORMAT MigrationFiles WITH(FORMAT_TYPE = DelimitedText,
FORMAT_OPTIONS (FIELD_TERMINATOR = '|'));
</code></pre>
<ol start="13">
<li>
<p>Open the C:\Hackathon\CreateExternalTables.sql file in SQL Server Management Studio.</p>
</li>
<li>
<p>This file contains all of the external table definitions for our tables and directly leverages the external data source and external file format we created above. Click Execute to create the external tables.</p>
</li>
</ol>
<img src="../images/execute_button2.jpg" class="block"/>
<ol start="15">
<li>Run the following code to verify that 33 tables were created.</li>
</ol>
<pre><code class="language-SQL">SELECT * FROM SYS.TABLES WHERE is_external = 1
</code></pre>
<ol start="16">
<li>We are about to load the warehouse. We would like to maximize performance of the load. To do this we will adjust the performance of the Azure SQL Data Warehouse by adjusting the scale slider in the Azure Portal. Navigate to your CohoDW SQL Data Warehouse and click on the Scale button.</li>
</ol>
<img src="../images/scale_button.jpg" class="block"/>
<ol start="17">
<li>In the Scale blade, adjust the Performance slider to 300 and click the Save button.</li>
</ol>
<img src="../images/scale_blade.jpg" class="block"/>
<ol start="18">
<li>Wait until the scaling process is complete to move on to the next step. You can view the SQL Data Warehouse status in the portal. The status will change from “Scaling” to “Online” and the Performance tier will reflect 300 DWUs when scaling is complete.</li>
</ol>
<img src="../images/scaling_status.jpg" class="block"/>
<ol start="19">
<li>
<p>From your <strong>SQLCohoDW</strong> virtual machine, open the C:\Hackathon\LoadData.sql file in SQL Server Management Studio.</p>
</li>
<li>
<p>The commands in this file insert data extracted directly from the data files stored in Azure Storage via the external tables we defined in the previous steps. Click execute to begin the data load.</p>
</li>
</ol>
<img src="../images/execute_button2.jpg" class="block"/>
<ol start="21">
<li>After your data is uploaded you can select data from any of the tables to verify success. In production environments, you would go through a much more thorough data validation process.</li>
</ol>
<div class="bs-callout bs-callout-primary"><h4>IMPORTANT!</h4>**Scale your SQL Data Warehouse back down to 100 to prevent excessive cost.**</div>

    </div>

            <nav class="hidden-print">
            <ul class="pager">
                                    <li class=pager-prev><a href="../Courseware/Data_and_Schema_Preparation.html">Previous</a></li>
                                                    <li class=pager-next><a href="../Courseware/Integrare_with_ADF.html">Next</a></li>            </ul>
        </nav>
    </article>
        </div>
        <div class="col-md-2 hidden-print">
            <div class="article-links" data-spy="affix" data-offset-top="100">
                
            </div>
        </div>
    </div>
</div>

    <div id="footer" class="container-fluid hidden-print">
        <div class="row">
            <div class="col-md-2 col-md-offset-1">
            
            </div>
            <div class="col-md-8" style="text-align:right;">
            This work is licensed under a Creative Commons Attribution 4.0 International License.
            </div>
        </div>
    </div>
    
    <script src="//ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <!-- JS -->
    
    <script src="../themes/azure/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <script src="../themes/azure/js/theme.js"></script>

</body>
</html>
